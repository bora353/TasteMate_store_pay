<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tastemate.mapper.StoreMapper">

    <resultMap id="storeMenuResultMap" type="com.tastemate.domain.StoreVO">
        <id column="STORE_IDX" property="storeIdx"/>
        <result column="STORE_NAME" property="storeName"/>
        <result column="USER_IDX" property="userIdx"/>
        <result column="CATEGORY1" property="category1"/>
        <result column="STORE_ADDRESS" property="storeAddress"/>
        <result column="STORE_LATI" property="storeLati"/>
        <result column="STORE_LONGI" property="storeLongi"/>
        <result column="PHONE_NUMBER" property="phoneNumber"/>
        <result column="STORE_COUNT" property="storeCount"/>
        <result column="FILENAME" property="filename"/>
        <collection property="menuVO" ofType="MenuVO">
            <id column="MENU_IDX" property="menuIdx" />
            <result column="STORE_IDX" property="storeIdx" />
            <result column="FOOD_NAME" property="foodName" />
            <result column="PRICE" property="price" />
        </collection>
    </resultMap>

    <resultMap id="storeStarResultMap" type="com.tastemate.domain.StoreVO">
        <id column="STORE_IDX" property="storeIdx"/>
        <result column="STORE_NAME" property="storeName"/>
        <result column="CATEGORY1" property="category1"/>
        <result column="STORE_ADDRESS" property="storeAddress"/>
        <result column="STORE_LATI" property="storeLati"/>
        <result column="STORE_LONGI" property="storeLongi"/>
        <result column="PHONE_NUMBER" property="phoneNumber"/>
        <result column="STORE_COUNT" property="storeCount"/>
        <result column="FILENAME" property="filename"/>
        <collection property="starVO" ofType="StarVO" javaType="java.util.List">
            <id column="STAR_IDX" property="starIdx" />
            <result column="STORE_IDX" property="storeIdx" />
            <result column="USER_IDX" property="userIdx" />
            <result column="STORE_STAR" property="storeStar" />
            <result column="USER_STAR" property="userStar" />
            <result column="STORE_COMMENT" property="storeComment" />
            <result column="USER_NAME" property="userName" />
        </collection>
    </resultMap>


<!-- 상세보기 화면에서 메뉴랑 가게정보 같이 받기-->
    <select id="getStoreWithMenu" resultMap="storeMenuResultMap">
        SELECT s.store_idx, s.user_idx, s.store_name, s.user_idx,
        s.category1, s.store_address, s.store_lati, s.store_longi, s.phone_number,
        s.store_count, s.filename, m.menu_idx, m.food_name, m.price
        FROM STORE s
        LEFT OUTER JOIN MENU m ON s.store_idx = m.store_idx
        WHERE s.store_idx = #{storeIdx}
    </select>

<!-- 상세보기 화면에서 별점 평균만 받기 -->
    <select id="getStoreWithStar" resultMap="storeStarResultMap">
        SELECT s.store_idx, s.user_idx, s.store_name, avg_star.store_star
        FROM STORE s
        LEFT OUTER JOIN (
        SELECT store_idx, ROUND(AVG(store_star), 1) AS store_star
        FROM STAR
        GROUP BY store_idx
        ) avg_star ON s.store_idx = avg_star.store_idx
        WHERE s.store_idx = #{storeIdx}
    </select>


<!-- 메인 맛집 전체보기 화면에서 별점과 같이 받기 -->
    <select id="store_getList_withStar" resultMap="storeStarResultMap"
                parameterType="string">
        <!--select * from store-->
        SELECT s.store_idx, s.user_idx, s.store_name, s.category1, s.store_address,
        s.store_lati, s.store_longi, s.phone_number, s.store_count, s.filename,
        avg_star.STORE_STAR
        FROM STORE s
        LEFT OUTER JOIN (
        SELECT store_idx, ROUND(AVG(store_star), 1) AS STORE_STAR
        FROM STAR
        GROUP BY store_idx
        ) avg_star ON s.store_idx = avg_star.store_idx

        <if test="cuisineSelect != '없음'">
            where category1 = #{cuisineSelect}
        </if>

        ORDER BY s.store_idx
    </select>

    <select id="store_get" resultType="StoreVO">
        select * from store
        where store_idx = #{storeIdx}
    </select>

    <!-- 맛집 등록하기 -->
    <insert id="store_register" parameterType="StoreVO">
        INSERT INTO STORE (STORE_IDX, USER_IDX, STORE_NAME, CATEGORY1,
                           STORE_ADDRESS, STORE_LATI, STORE_LONGI, PHONE_NUMBER, STORE_COUNT,
        FILENAME
                           )
        VALUES (store_seq.NEXTVAL, #{userIdx}, #{storeName}, #{category1},
                #{storeAddress}, #{storeLati}, #{storeLongi}, #{phoneNumber}, 0,
        #{filename}
                )
    </insert>

    <!-- 맛집 평가 조회하기 -->
    <select id="getStoreWithComment" resultMap="storeStarResultMap">
<!--        select s.store_idx, s.user_idx, s.store_name, r.star_idx, r.store_comment, r.store_star
        from store s
                 LEFT OUTER JOIN
             star r on s.store_idx = r.store_idx
        WHERE s.store_idx = #{storeIdx}-->
        select s.store_idx, s.user_idx, s.store_name, r.star_idx,
        r.store_comment, r.store_star
        ,m.user_idx, m.user_name
        from store s
        LEFT OUTER JOIN
        star r on s.store_idx = r.store_idx
        left outer join
        member m on m.user_idx = r.user_idx
        WHERE s.store_idx = #{storeIdx}
    </select>

    <!-- 맛집 삭제 -->
    <delete id="store_delete">
        delete from store
        where store_idx = #{storeIdx}
    </delete>

    <!-- 맛집 업데이트 -->
    <update id="store_update" parameterType="StoreVO">
        UPDATE store
        SET
        STORE_NAME = #{storeName},
        CATEGORY1 = #{category1},
        STORE_ADDRESS = #{storeAddress},
        STORE_LATI = #{storeLati},
        STORE_LONGI = #{storeLongi},
        PHONE_NUMBER = #{phoneNumber},
        FILENAME = #{filename}

        WHERE store_idx = #{storeIdx}

    </update>

</mapper>